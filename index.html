<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrandSafe | Design Workbench</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Dynamic Font Links -->
    <link id="header-font-link" rel="stylesheet" href="">
    <link id="body-font-link" rel="stylesheet" href="">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        agency: {
                            900: '#0f172a',
                            800: '#1e293b',
                            700: '#334155',
                            600: '#475569',
                            500: '#64748b',
                            accent: '#3b82f6'
                        }
                    }
                }
            }
        }
    </script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Html2Canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* Custom Utilities */
        body { background-color: #0f172a; color: #f8fafc; }
        
        /* Swatch Interactions */
        .swatch-delete { opacity: 0; transition: opacity 0.2s ease; }
        .swatch-container:hover .swatch-delete { opacity: 1; }
        .swatch-container:active { transform: scale(0.95); }
        
        /* Color input styling override */
        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 32px;
            height: 32px;
            padding: 0;
            overflow: hidden;
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 50%; border: 1px solid #475569; }
        
        /* Smooth transitions */
        .transition-colors-fast { transition: color 0.1s, background-color 0.1s, border-color 0.1s; }
        
        /* Active Mode Indicator Animation */
        .mode-active {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
            background-color: rgba(30, 41, 59, 1);
        }
        .mode-inactive {
            opacity: 0.7;
        }
        .mode-inactive:hover {
            opacity: 1;
            background-color: rgba(30, 41, 59, 0.8);
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Crosshair cursor for image picker */
        .cursor-crosshair { cursor: crosshair; }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            margin-top: -5px; 
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 2px;
            cursor: pointer;
            background: #475569;
        }
        
        /* Slide Modal */
        .slide-modal {
            backdrop-filter: blur(10px);
            background-color: rgba(15, 23, 42, 0.9);
        }
        
        /* 16:9 Aspect Ratio */
        .aspect-16-9 {
            aspect-ratio: 16 / 9;
        }

        /* High Visibility Badge Style on Slide */
        .slide-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 6px 14px;
            border-radius: 8px;
            /* Increased visibility for export */
            background-color: rgba(255, 255, 255, 0.1); 
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-weight: 700;
            font-size: 0.85rem;
            white-space: nowrap; /* Prevents wrapping/dropping out */
            min-width: 80px; /* Forces minimum width */
        }
        .slide-badge i {
            font-size: 1.2rem;
            /* Ensure colors pop */
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5)); 
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-200">

    <!-- Header -->
    <header class="border-b border-agency-700 bg-agency-900/95 backdrop-blur px-6 py-4 flex justify-between items-center z-10 shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-lg">B</div>
            <h1 class="text-xl font-bold tracking-tight">Brand<span class="text-blue-500">Safe</span></h1>
        </div>
        <div class="flex items-center gap-4">
             <button id="btn-show-slide" class="text-xs bg-agency-700 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition font-medium flex items-center gap-2">
                <i class="fa-solid fa-desktop"></i> Presentation Mode
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
        
        <!-- LEFT PANEL: Image & Palette -->
        <section class="w-full md:w-5/12 lg:w-4/12 border-r border-agency-700 flex flex-col bg-agency-800/50 overflow-y-auto custom-scrollbar">
            <div class="p-6 space-y-8">
                
                <!-- Upload Zone / Image Canvas -->
                <div>
                    <div class="flex justify-between items-end mb-3">
                        <h2 class="text-sm font-semibold text-agency-500 uppercase tracking-wider">1. Source Image</h2>
                        <div class="flex gap-3 items-center">
                            <span id="picker-hint" class="text-[10px] text-blue-400 opacity-0 transition-opacity">Click to pick</span>
                            <button id="btn-reset-image" class="text-[10px] text-slate-400 hover:text-white underline hidden">Change Image</button>
                        </div>
                    </div>

                    <div id="drop-zone" class="relative border-2 border-dashed border-agency-600 rounded-xl bg-agency-800 text-center transition cursor-pointer group min-h-[200px] flex flex-col items-center justify-center overflow-hidden">
                        
                        <!-- File Input overlay -->
                        <input type="file" id="file-input" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20">
                        
                        <!-- Empty State -->
                        <div id="upload-placeholder" class="pointer-events-none p-8">
                            <i class="fa-solid fa-eye-dropper text-3xl text-agency-500 mb-3 group-hover:text-blue-400 transition"></i>
                            <p class="text-sm font-medium text-slate-300">Upload Image</p>
                            <p class="text-xs text-slate-500 mt-1">to enable color picker</p>
                        </div>

                        <!-- Image Canvas (Hidden until loaded) -->
                        <div id="canvas-container" class="hidden relative w-full h-full bg-agency-900 z-10">
                            <!-- Helper Canvas -->
                            <canvas id="img-canvas" class="cursor-crosshair w-full h-auto object-contain block mx-auto"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Palette Section -->
                <div>
                     <div class="flex justify-between items-center mb-3">
                        <h2 class="text-sm font-semibold text-agency-500 uppercase tracking-wider">2. Palette</h2>
                        <button id="clear-palette" class="text-[10px] text-slate-500 hover:text-red-400 underline">Clear All</button>
                     </div>
                     
                     <!-- Quick Tools -->
                     <div class="flex flex-wrap gap-2 mb-4">
                        <button onclick="handleSwatchClick('#000000')" class="w-10 h-10 rounded-lg bg-black border border-agency-600 hover:scale-105 transition shadow-lg relative group" title="Pure Black">
                            <span class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 bg-black/50 text-white rounded-lg"><i class="fa-solid fa-plus text-xs"></i></span>
                        </button>
                        <button onclick="handleSwatchClick('#ffffff')" class="w-10 h-10 rounded-lg bg-white border border-agency-600 hover:scale-105 transition shadow-lg relative group" title="Pure White">
                             <span class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 bg-black/20 text-black rounded-lg"><i class="fa-solid fa-plus text-xs"></i></span>
                        </button>

                        <div class="flex-1 flex min-w-[140px]">
                            <input type="text" id="manual-hex-input" placeholder="#HEX..." class="w-full bg-agency-900 border border-agency-600 border-r-0 rounded-l-lg px-3 text-xs font-mono uppercase focus:outline-none focus:border-blue-500">
                            <button id="btn-add-manual" class="bg-agency-700 hover:bg-agency-600 border border-agency-600 px-3 rounded-r-lg text-slate-300 transition">
                                <i class="fa-solid fa-plus text-xs"></i>
                            </button>
                        </div>
                     </div>

                    <!-- Palette Grid -->
                    <div id="palette-grid" class="grid grid-cols-5 gap-3 min-h-[60px]">
                        <div class="col-span-5 text-center py-8 text-agency-600 text-sm border-2 border-dashed border-agency-700/50 rounded-lg">
                            Click image to extract colors
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- RIGHT PANEL: Editor & Checks -->
        <section class="flex-1 bg-agency-900 flex flex-col overflow-y-auto custom-scrollbar">
            <div class="p-6 md:p-8 lg:p-10 max-w-5xl mx-auto w-full space-y-8">

                <!-- Editor Controls -->
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-sm font-semibold text-agency-500 uppercase tracking-wider">Design Workbench</h2>
                        <!-- Format Toggle -->
                        <div class="flex bg-agency-800 rounded-lg p-1 border border-agency-700">
                            <button onclick="toggleFormat('hex')" id="fmt-hex" class="px-3 py-1 text-[10px] font-bold rounded bg-slate-600 text-white shadow-sm transition-all">HEX</button>
                            <button onclick="toggleFormat('rgb')" id="fmt-rgb" class="px-3 py-1 text-[10px] font-bold rounded text-slate-500 hover:text-slate-300 transition-all">RGB</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <!-- Background Control -->
                        <div id="control-bg" class="bg-agency-800 p-5 rounded-xl border border-agency-700 transition-all duration-200 group relative mode-active">
                            <!-- Click overlay for mode selection -->
                            <div class="absolute inset-0 z-0 cursor-pointer" onclick="setMode('bg')"></div>

                            <div class="relative z-10 pointer-events-none">
                                <div class="flex justify-between items-start mb-2">
                                    <label class="text-xs font-semibold text-agency-500 uppercase tracking-wider">Background</label>
                                    <div class="w-3 h-3 rounded-full bg-slate-600" id="indicator-bg"></div>
                                </div>
                                <div class="flex items-center gap-4 pointer-events-auto">
                                    <div class="w-10 h-10 rounded-lg border border-agency-600 shadow-inner transition-colors" id="bg-visual-indicator"></div>
                                    <div class="flex-1">
                                        <input type="text" id="bg-text" class="bg-transparent border-b border-agency-600 text-white font-mono text-lg font-medium w-full focus:outline-none focus:border-blue-500 uppercase py-1 transition-colors">
                                    </div>
                                    <button onclick="addToPalette('bg')" class="pointer-events-auto text-slate-500 hover:text-blue-400 transition" title="Add to Palette">
                                        <i class="fa-solid fa-square-plus text-xl"></i>
                                    </button>
                                    <input type="color" id="bg-picker" class="opacity-50 hover:opacity-100 transition-opacity">
                                </div>
                                <!-- Lightness Slider -->
                                <div class="mt-3 pt-3 border-t border-agency-700/50 pointer-events-auto">
                                    <div class="flex justify-between text-[10px] text-slate-500 mb-1">
                                        <span>Darker</span>
                                        <span>Lightness</span>
                                        <span>Lighter</span>
                                    </div>
                                    <input type="range" id="bg-lightness" min="-20" max="20" value="0" step="1" class="w-full">
                                </div>
                            </div>
                        </div>

                        <!-- Text Control -->
                        <div id="control-text" class="bg-agency-800 p-5 rounded-xl border border-agency-700 transition-all duration-200 group relative mode-inactive">
                             <!-- Click overlay for mode selection -->
                             <div class="absolute inset-0 z-0 cursor-pointer" onclick="setMode('text')"></div>

                             <div class="relative z-10 pointer-events-none">
                                <div class="flex justify-between items-start mb-2">
                                    <label class="text-xs font-semibold text-agency-500 uppercase tracking-wider">Typography</label>
                                    <div class="w-3 h-3 rounded-full bg-slate-600" id="indicator-text"></div>
                                </div>
                                <div class="flex items-center gap-4 pointer-events-auto">
                                    <div class="w-10 h-10 rounded-lg border border-agency-600 shadow-inner transition-colors" id="text-visual-indicator"></div>
                                    <div class="flex-1">
                                        <input type="text" id="text-text" class="bg-transparent border-b border-agency-600 text-white font-mono text-lg font-medium w-full focus:outline-none focus:border-blue-500 uppercase py-1 transition-colors">
                                    </div>
                                    <button onclick="addToPalette('text')" class="pointer-events-auto text-slate-500 hover:text-blue-400 transition" title="Add to Palette">
                                        <i class="fa-solid fa-square-plus text-xl"></i>
                                    </button>
                                    <input type="color" id="text-picker" class="opacity-50 hover:opacity-100 transition-opacity">
                                </div>
                                <!-- Lightness Slider -->
                                <div class="mt-3 pt-3 border-t border-agency-700/50 pointer-events-auto">
                                    <div class="flex justify-between text-[10px] text-slate-500 mb-1">
                                        <span>Darker</span>
                                        <span>Lightness</span>
                                        <span>Lighter</span>
                                    </div>
                                    <input type="range" id="text-lightness" min="-20" max="20" value="0" step="1" class="w-full">
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Stats & Checks -->
                <div class="bg-agency-800 rounded-2xl p-6 border border-agency-700 shadow-lg">
                     <!-- Header -->
                     <div class="flex justify-between items-start mb-6 gap-4">
                        <div class="flex flex-col min-w-0">
                            <h2 class="text-sm font-semibold text-agency-500 uppercase tracking-wider truncate">WCAG Check</h2>
                            <span class="text-xs text-agency-600 mt-1">Raw Ratio: <span id="contrast-ratio" class="font-mono font-bold">--</span></span>
                        </div>
                        <button id="btn-swap" class="shrink-0 bg-agency-700 hover:bg-agency-600 border border-agency-600 text-slate-300 px-3 py-2 rounded-lg transition flex items-center justify-center gap-2 text-xs font-medium shadow-sm">
                            <i class="fa-solid fa-arrow-right-arrow-left"></i> Swap
                        </button>
                    </div>

                    <!-- Grid -->
                    <div class="grid grid-cols-2 gap-4 mb-1 px-1">
                        <div class="text-xs font-bold text-agency-500 uppercase tracking-widest opacity-70">Level AA</div>
                        <div class="text-xs font-bold text-agency-500 uppercase tracking-widest opacity-70">Level AAA</div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <!-- AA Normal -->
                        <div class="bg-agency-900/50 p-3 rounded-lg border border-agency-700 flex justify-between items-center gap-3 group hover:bg-agency-900 transition">
                            <div class="min-w-0">
                                <p class="text-xs text-slate-400 font-medium truncate">Normal Text</p>
                                <p class="text-[10px] text-slate-500">Target: 4.5</p>
                            </div>
                            <div id="badge-aa-normal" class="text-red-500 shrink-0"><i class="fa-solid fa-circle-xmark text-lg"></i></div>
                        </div>
                        <!-- AAA Normal -->
                        <div class="bg-agency-900/50 p-3 rounded-lg border border-agency-700 flex justify-between items-center gap-3 group hover:bg-agency-900 transition">
                            <div class="min-w-0">
                                <p class="text-xs text-slate-400 font-medium truncate">Normal Text</p>
                                <p class="text-[10px] text-slate-500">Target: 7.0</p>
                            </div>
                            <div id="badge-aaa-normal" class="text-red-500 shrink-0"><i class="fa-solid fa-circle-xmark text-lg"></i></div>
                        </div>
                        <!-- AA Large -->
                        <div class="bg-agency-900/50 p-3 rounded-lg border border-agency-700 flex justify-between items-center gap-3 group hover:bg-agency-900 transition">
                            <div class="min-w-0">
                                <p class="text-xs text-slate-400 font-medium truncate">Large Text</p>
                                <p class="text-[10px] text-slate-500">Target: 3.0</p>
                            </div>
                            <div id="badge-aa-large" class="text-red-500 shrink-0"><i class="fa-solid fa-circle-xmark text-lg"></i></div>
                        </div>
                        <!-- AAA Large -->
                        <div class="bg-agency-900/50 p-3 rounded-lg border border-agency-700 flex justify-between items-center gap-3 group hover:bg-agency-900 transition">
                            <div class="min-w-0">
                                <p class="text-xs text-slate-400 font-medium truncate">Large Text</p>
                                <p class="text-[10px] text-slate-500">Target: 4.5</p>
                            </div>
                            <div id="badge-aaa-large" class="text-red-500 shrink-0"><i class="fa-solid fa-circle-xmark text-lg"></i></div>
                        </div>
                    </div>
                </div>

                <!-- Live Preview (Small) -->
                <div>
                    <h2 class="text-sm font-semibold text-agency-500 mb-3 uppercase tracking-wider">Working Preview</h2>
                    <div id="preview-card" class="w-full p-8 rounded-xl shadow-inner transition-colors-fast border border-slate-700/20 flex flex-col items-start gap-4">
                        <h3 id="preview-headline" class="text-2xl font-bold tracking-tight leading-tight">
                            Design with purpose.
                        </h3>
                        <p id="preview-body" class="text-base opacity-80 leading-relaxed font-light">
                            Accessibility is not a constraint, it is the foundation of clarity.
                        </p>
                    </div>
                </div>

            </div>
        </section>
    </main>

    <!-- SLIDE PRESENTATION MODAL -->
    <div id="slide-modal" class="fixed inset-0 z-50 hidden slide-modal flex items-center justify-center p-4 md:p-8">
        
        <!-- Controls overlay (Top Right) -->
        <div class="absolute top-4 right-4 flex gap-3 z-50">
             <button id="download-slide" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-full shadow-lg font-semibold flex items-center gap-2 transition">
                <i class="fa-solid fa-download"></i> Download PNG
            </button>
            <button id="close-slide" class="text-slate-400 hover:text-white bg-agency-800 p-2 rounded-full w-10 h-10 flex items-center justify-center transition">
                <i class="fa-solid fa-times text-xl"></i>
            </button>
        </div>

        <!-- Controls overlay (Top Left) -->
        <div class="absolute top-4 left-4 z-50 flex flex-col gap-2 items-start bg-agency-800/90 backdrop-blur p-3 rounded-lg border border-agency-700 shadow-xl">
            <div class="flex items-center gap-2">
                <label class="text-[10px] text-slate-400 font-bold w-16">HEADER:</label>
                <input list="google-fonts-list" id="font-header-input" class="bg-agency-900 border border-agency-600 rounded px-2 py-1 text-xs text-white w-40 placeholder-slate-500 focus:outline-none focus:border-blue-500" placeholder="Font name...">
            </div>
            <div class="flex items-center gap-2">
                <label class="text-[10px] text-slate-400 font-bold w-16">BODY:</label>
                <input list="google-fonts-list" id="font-body-input" class="bg-agency-900 border border-agency-600 rounded px-2 py-1 text-xs text-white w-40 placeholder-slate-500 focus:outline-none focus:border-blue-500" placeholder="Font name...">
            </div>
            <datalist id="google-fonts-list">
                <!-- Populated via JS -->
            </datalist>
        </div>

        <div class="w-full max-w-6xl aspect-16-9 bg-agency-900 relative shadow-2xl rounded-sm overflow-hidden flex flex-col transition-colors-fast" id="slide-container">
            <!-- Slide Content -->
            <div class="flex-1 px-16 py-12 md:px-20 md:py-16 flex flex-col justify-center relative z-10">
                
                <!-- Top Section: Titles, Colors, Icon -->
                <div class="flex justify-between items-end mb-8">
                    <!-- Left: Titles -->
                    <div class="flex flex-col justify-center gap-2"> <!-- Increased Gap -->
                        <!-- Removed leading-none, added Margin Bottom for safety -->
                        <h1 id="slide-main-title" class="text-5xl md:text-6xl font-bold tracking-tighter mb-4">
                            Huisstijl.
                        </h1>
                        <p id="slide-subtitle" class="text-2xl opacity-60 font-light mt-2">
                            WCAG Validatie & Kleurenpalet
                        </p>
                    </div>

                    <!-- Right: Colors & Icon -->
                    <div class="flex items-center gap-8">
                        <div class="flex flex-col items-end text-right gap-3">
                            <div>
                                <span class="text-xs uppercase tracking-widest font-bold opacity-50 block mb-1 font-sans">Achtergrond</span>
                                <span id="slide-bg-val" class="font-mono text-2xl">#1E293B</span>
                            </div>
                            <div>
                                <span class="text-xs uppercase tracking-widest font-bold opacity-50 block mb-1 font-sans">Typografie</span>
                                <span id="slide-text-val" class="font-mono text-2xl">#FFFFFF</span>
                            </div>
                        </div>
                        <!-- Icon -->
                        <div class="opacity-20">
                            <i class="fa-solid fa-universal-access text-6xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Divider -->
                <div class="w-full h-px bg-current opacity-20 mb-10"></div>

                <!-- Bottom Section: Text Examples -->
                <div class="flex-1 grid grid-cols-[1fr_auto_1fr] gap-12 items-start">
                    
                    <!-- Left Column: Large Text -->
                    <div class="flex flex-col gap-6">
                        <!-- Header for Column -->
                        <div class="flex justify-between items-center border-b border-current border-opacity-10 pb-3">
                            <span class="text-xs uppercase tracking-widest font-bold opacity-50 font-sans">Grote teksten (koppen)</span>
                            <div class="flex gap-2">
                                <div id="slide-badge-aa-large" class="slide-badge"></div>
                                <div id="slide-badge-aaa-large" class="slide-badge"></div>
                            </div>
                        </div>
                        <!-- Text -->
                        <p id="slide-example-header" class="text-5xl font-bold leading-tight">
                            Lorem ipsum dolor sit amet.
                        </p>
                    </div>

                    <!-- Center: Vertical Divider -->
                    <div class="w-px h-full bg-current opacity-20"></div>

                    <!-- Right Column: Normal Text -->
                    <div class="flex flex-col gap-6">
                        <!-- Header for Column -->
                        <div class="flex justify-between items-center border-b border-current border-opacity-10 pb-3">
                            <span class="text-xs uppercase tracking-widest font-bold opacity-50 font-sans">Normale tekst (broodtekst)</span>
                            <div class="flex gap-2">
                                <div id="slide-badge-aa-norm" class="slide-badge"></div>
                                <div id="slide-badge-aaa-norm" class="slide-badge"></div>
                            </div>
                        </div>
                        <!-- Text -->
                        <p id="slide-example-body" class="text-xl leading-relaxed opacity-90">
                            Consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam.
                        </p>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script>
        // --- State ---
        const state = {
            bg: '#1e293b',
            text: '#ffffff',
            activeMode: 'bg',
            displayFormat: 'hex',
            palette: [],
            baseBg: '#1e293b',
            baseText: '#ffffff',
            headerFont: 'Inter',
            bodyFont: 'Inter'
        };

        // --- Top 300 + Modern Google Fonts List ---
        const popularGoogleFonts = [
            "Bricolage Grotesque", "Inter", "Roboto", "Open Sans", "Noto Sans JP", "Lato", "Montserrat", "Roboto Condensed", "Source Sans Pro", "Oswald", "Poppins", 
            "Roboto Mono", "Raleway", "Noto Sans", "PT Sans", "Mukta", "Merriweather", "Roboto Slab", "Nunito", "Playfair Display", 
            "Rubik", "Lora", "Work Sans", "Nunito Sans", "Fira Sans", "Quicksand", "Barlow", "Inconsolata", "Titillium Web", 
            "PT Serif", "Heebo", "Libre Franklin", "DM Sans", "Arimo", "Karla", "Josefin Sans", "Mulish", "Libre Baskerville", 
            "Ubuntu", "PT Sans Narrow", "Oxygen", "Bebas Neue", "Bitter", "Cabin", "Dancing Script", "Source Code Pro", "Abel", 
            "Prompt", "Varela Round", "Exo 2", "Anton", "Maven Pro", "Hind", "Fjalla One", "Crimson Text", "Pacifico", "Lobster", 
            "Yanone Kaffeesatz", "Comfortaa", "Arvo", "Noto Serif", "Slabo 27px", "Merriweather Sans", "Asap", "Signika", 
            "Archivo Narrow", "Questrial", "Catamaran", "Cairo", "Amatic SC", "Cuprum", "Muli", "Frank Ruhl Libre", 
            "Barlow Condensed", "Play", "Pathway Gothic One", "Rokkitt", "Alegreya", "Exo", "EB Garamond", "Righteous", "Crete Round", 
            "Overpass", "Old Standard TT", "Cinzel", "Domine", "Changa", "Rajdhani", "Cormorant Garamond", "Kanit", "Teko", 
            "Source Serif Pro", "Permanent Marker", "Bree Serif", "Vollkorn", "Patua One", "Abril Fatface", "Cookie", "Francois One", 
            "Russo One", "Acme", "Alegreya Sans", "Chivo", "Alfa Slab One", "Didact Gothic", "Great Vibes", "Amaranth", "Philosopher", 
            "Satisfy", "Courgette", "Quattrocento Sans", "Gloria Hallelujah", "News Cycle", "Glegoo", "Saira Condensed", 
            "Cardo", "Fredoka One", "Jura", "Orbitron", "Kalam", "Volkhov", "Sacramento", "Prata", 
            "Yellowtail", "Poiret One", "Monoton", "Kaushan Script", "Marck Script", "Space Grotesk", "Syne", "Outfit", "Epilogue", 
            "Manrope", "Urbanist", "Be Vietnam Pro", "Plus Jakarta Sans", "Lexend", "Sora", "JetBrains Mono"
        ].sort();

        // --- Elements ---
        const els = {
            // Left Panel
            fileInput: document.getElementById('file-input'),
            dropZone: document.getElementById('drop-zone'),
            uploadPlaceholder: document.getElementById('upload-placeholder'),
            canvasContainer: document.getElementById('canvas-container'),
            canvas: document.getElementById('img-canvas'),
            pickerHint: document.getElementById('picker-hint'),
            paletteGrid: document.getElementById('palette-grid'),
            manualInput: document.getElementById('manual-hex-input'),
            btnAddManual: document.getElementById('btn-add-manual'),
            btnClearPalette: document.getElementById('clear-palette'),
            btnResetImage: document.getElementById('btn-reset-image'),

            // Format
            fmtHex: document.getElementById('fmt-hex'),
            fmtRgb: document.getElementById('fmt-rgb'),

            // Controls
            controlBg: document.getElementById('control-bg'),
            controlText: document.getElementById('control-text'),
            indicatorBg: document.getElementById('indicator-bg'),
            indicatorText: document.getElementById('indicator-text'),
            
            // Inputs
            bgPicker: document.getElementById('bg-picker'),
            bgText: document.getElementById('bg-text'),
            bgLightness: document.getElementById('bg-lightness'),
            
            textPicker: document.getElementById('text-picker'),
            textText: document.getElementById('text-text'),
            textLightness: document.getElementById('text-lightness'),

            btnSwap: document.getElementById('btn-swap'),
            
            // Visuals
            bgVisual: document.getElementById('bg-visual-indicator'),
            textVisual: document.getElementById('text-visual-indicator'),
            
            // Preview
            card: document.getElementById('preview-card'),
            
            // Scoreboard
            ratioDisplay: document.getElementById('contrast-ratio'),
            badges: {
                aaNorm: document.getElementById('badge-aa-normal'),
                aaaNorm: document.getElementById('badge-aaa-normal'),
                aaLarge: document.getElementById('badge-aa-large'),
                aaaLarge: document.getElementById('badge-aaa-large'),
            },

            // Slide
            btnShowSlide: document.getElementById('btn-show-slide'),
            slideModal: document.getElementById('slide-modal'),
            btnCloseSlide: document.getElementById('close-slide'),
            btnDownloadSlide: document.getElementById('download-slide'),
            slideContainer: document.getElementById('slide-container'),
            slideBgVal: document.getElementById('slide-bg-val'),
            slideTextVal: document.getElementById('slide-text-val'),
            // Slide Elements
            slideMainTitle: document.getElementById('slide-main-title'),
            slideSubtitle: document.getElementById('slide-subtitle'),
            slideExampleHeader: document.getElementById('slide-example-header'),
            slideExampleBody: document.getElementById('slide-example-body'),
            slideBadges: {
                aaNorm: document.getElementById('slide-badge-aa-norm'),
                aaaNorm: document.getElementById('slide-badge-aaa-norm'),
                aaLarge: document.getElementById('slide-badge-aa-large'),
                aaaLarge: document.getElementById('slide-badge-aaa-large'),
            },
            // Font Controls
            fontHeaderInput: document.getElementById('font-header-input'),
            fontBodyInput: document.getElementById('font-body-input'),
            fontsDatalist: document.getElementById('google-fonts-list'),
            headerFontLink: document.getElementById('header-font-link'),
            bodyFontLink: document.getElementById('body-font-link')
        };

        // --- Init ---
        function init() {
            setMode('bg');
            updateUI();
            setupEvents();
            setupFonts();
        }

        function setupFonts() {
            // Populate Datalist
            els.fontsDatalist.innerHTML = popularGoogleFonts.map(f => `<option value="${f}">`).join('');
            
            // Load saved fonts
            const savedHeader = localStorage.getItem('brandSafe_headerFont');
            const savedBody = localStorage.getItem('brandSafe_bodyFont');
            
            if (savedHeader) {
                state.headerFont = savedHeader;
                els.fontHeaderInput.value = savedHeader;
                loadGoogleFont(savedHeader, 'header');
            }
            if (savedBody) {
                state.bodyFont = savedBody;
                els.fontBodyInput.value = savedBody;
                loadGoogleFont(savedBody, 'body');
            }
        }

        // --- Event Listeners ---
        function setupEvents() {
            // Canvas/Upload
            els.fileInput.addEventListener('change', handleImageUpload);
            
            els.fileInput.addEventListener('dragenter', () => els.dropZone.classList.add('border-blue-500', 'bg-agency-700/50'));
            els.fileInput.addEventListener('dragover', () => els.dropZone.classList.add('border-blue-500', 'bg-agency-700/50'));
            els.fileInput.addEventListener('dragleave', () => els.dropZone.classList.remove('border-blue-500', 'bg-agency-700/50'));
            els.fileInput.addEventListener('drop', () => els.dropZone.classList.remove('border-blue-500', 'bg-agency-700/50'));

            els.canvas.addEventListener('click', handleCanvasClick);
            els.btnResetImage.addEventListener('click', resetImage);
            
            // Manual Palette
            els.btnAddManual.addEventListener('click', addManualPaletteColor);
            els.manualInput.addEventListener('keypress', (e) => { if(e.key==='Enter') addManualPaletteColor() });
            els.btnClearPalette.addEventListener('click', () => {
                state.palette = [];
                renderPalette();
            });

            // Native Pickers
            els.bgPicker.addEventListener('input', (e) => {
                state.baseBg = e.target.value;
                els.bgLightness.value = 0; 
                updateColor('bg', e.target.value);
            });
            els.textPicker.addEventListener('input', (e) => {
                state.baseText = e.target.value;
                els.textLightness.value = 0; 
                updateColor('text', e.target.value);
            });

            // Manual Text Inputs
            els.bgText.addEventListener('input', (e) => handleManualInput('bg', e.target.value));
            els.textText.addEventListener('input', (e) => handleManualInput('text', e.target.value));

            // Lightness Sliders
            els.bgLightness.addEventListener('input', (e) => adjustLightness('bg', e.target.value));
            els.textLightness.addEventListener('input', (e) => adjustLightness('text', e.target.value));

            // Swap
            els.btnSwap.addEventListener('click', () => {
                const temp = state.bg;
                const tempBase = state.baseBg;
                state.bg = state.text;
                state.baseBg = state.baseText;
                state.text = temp;
                state.baseText = tempBase;
                els.bgLightness.value = 0;
                els.textLightness.value = 0;
                updateUI();
            });

            // Slide
            els.btnShowSlide.addEventListener('click', () => {
                updateSlideCompliance();
                els.slideModal.classList.remove('hidden');
            });
            els.btnCloseSlide.addEventListener('click', () => els.slideModal.classList.add('hidden'));
            els.slideModal.addEventListener('click', (e) => {
                if(e.target === els.slideModal) els.slideModal.classList.add('hidden');
            });
            els.btnDownloadSlide.addEventListener('click', downloadSlide);

            // Font Inputs
            els.fontHeaderInput.addEventListener('change', (e) => {
                const fontName = e.target.value.trim();
                if(fontName) {
                    loadGoogleFont(fontName, 'header');
                    localStorage.setItem('brandSafe_headerFont', fontName);
                }
            });
            els.fontBodyInput.addEventListener('change', (e) => {
                const fontName = e.target.value.trim();
                if(fontName) {
                    loadGoogleFont(fontName, 'body');
                    localStorage.setItem('brandSafe_bodyFont', fontName);
                }
            });
        }

        // --- Font Logic ---
        function loadGoogleFont(fontName, type) {
            if(!fontName) return;
            
            const input = type === 'header' ? els.fontHeaderInput : els.fontBodyInput;
            const linkTag = type === 'header' ? els.headerFontLink : els.bodyFontLink;
            
            input.classList.add('border-yellow-500');
            input.classList.remove('border-agency-600', 'border-red-500', 'border-green-500');

            const url = `https://fonts.googleapis.com/css2?family=${fontName.replace(/ /g, '+')}:wght@300;400;700;800&display=swap`;
            
            linkTag.onload = () => {
                if (type === 'header') {
                    state.headerFont = fontName;
                    els.slideMainTitle.style.fontFamily = `"${fontName}", sans-serif`;
                    els.slideExampleHeader.style.fontFamily = `"${fontName}", sans-serif`;
                } else {
                    state.bodyFont = fontName;
                    els.slideSubtitle.style.fontFamily = `"${fontName}", sans-serif`;
                    els.slideExampleBody.style.fontFamily = `"${fontName}", sans-serif`;
                }
                input.classList.remove('border-yellow-500');
                input.classList.add('border-green-500');
            };

            linkTag.onerror = () => {
                input.classList.remove('border-yellow-500');
                input.classList.add('border-red-500');
                alert(`Could not load font "${fontName}"`);
            };

            linkTag.href = url;
        }

        // --- Image Handling ---
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    els.uploadPlaceholder.classList.add('hidden');
                    els.canvasContainer.classList.remove('hidden');
                    els.pickerHint.classList.remove('opacity-0');
                    els.fileInput.classList.add('hidden');
                    els.btnResetImage.classList.remove('hidden');
                    els.canvas.width = img.width;
                    els.canvas.height = img.height;
                    const ctx = els.canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function resetImage() {
            els.fileInput.value = ''; 
            els.fileInput.classList.remove('hidden'); 
            els.btnResetImage.classList.add('hidden'); 
            els.pickerHint.classList.add('opacity-0');
            els.canvasContainer.classList.add('hidden');
            els.uploadPlaceholder.classList.remove('hidden');
            const ctx = els.canvas.getContext('2d');
            ctx.clearRect(0, 0, els.canvas.width, els.canvas.height);
        }

        function handleCanvasClick(e) {
            const rect = els.canvas.getBoundingClientRect();
            const scaleX = els.canvas.width / rect.width;
            const scaleY = els.canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            const ctx = els.canvas.getContext('2d');
            const pixel = ctx.getImageData(x, y, 1, 1).data;
            const hex = rgbToHex(pixel[0], pixel[1], pixel[2]);
            if (!state.palette.includes(hex)) {
                state.palette.push(hex);
                renderPalette();
            }
            handleSwatchClick(hex);
        }

        // --- Color Logic ---
        window.handleSwatchClick = function(hex) {
            if (state.activeMode === 'bg') {
                state.baseBg = hex;
                els.bgLightness.value = 0;
            } else {
                state.baseText = hex;
                els.textLightness.value = 0;
            }
            updateColor(state.activeMode, hex);
        }

        window.addToPalette = function(type) {
            const hex = type === 'bg' ? state.bg : state.text;
            if (!state.palette.includes(hex)) {
                state.palette.push(hex);
                renderPalette();
            }
        }

        window.deleteSwatch = function(index) {
            state.palette.splice(index, 1);
            renderPalette();
        }

        function addManualPaletteColor() {
            let hex = els.manualInput.value.trim();
            if (!hex.startsWith('#')) hex = '#' + hex;
            if (isValidHex(hex)) {
                state.palette.push(hex);
                renderPalette();
                els.manualInput.value = '';
                handleSwatchClick(hex);
            }
        }

        function renderPalette() {
            els.paletteGrid.innerHTML = '';
            if (state.palette.length === 0) {
                 els.paletteGrid.innerHTML = `<div class="col-span-5 text-center py-8 text-agency-600 text-sm border-2 border-dashed border-agency-700/50 rounded-lg">Click image to extract colors</div>`;
                 return;
            }
            state.palette.forEach((hex, index) => {
                const swatch = document.createElement('div');
                swatch.className = 'swatch-container relative w-full pt-[100%] rounded-lg cursor-pointer shadow-md border border-slate-700/50 overflow-hidden group hover:scale-105 transition-transform duration-200';
                swatch.style.backgroundColor = hex;
                swatch.addEventListener('click', (e) => {
                    if(e.target.closest('.delete-btn')) return;
                    handleSwatchClick(hex);
                });
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn swatch-delete absolute top-1 right-1 w-6 h-6 bg-black/60 hover:bg-red-500 text-white rounded-full flex items-center justify-center transition-colors z-10';
                deleteBtn.innerHTML = '<i class="fa-solid fa-times text-[10px]"></i>';
                deleteBtn.onclick = (e) => { e.stopPropagation(); deleteSwatch(index); };
                swatch.appendChild(deleteBtn);
                els.paletteGrid.appendChild(swatch);
            });
        }

        // --- Visual Editor ---
        function adjustLightness(type, amount) {
            const baseHex = type === 'bg' ? state.baseBg : state.baseText;
            const amt = parseInt(amount);
            const rgb = hexToRgb(baseHex);
            const shift = amt * 5; 
            const newR = clamp(rgb.r + shift);
            const newG = clamp(rgb.g + shift);
            const newB = clamp(rgb.b + shift);
            const newHex = rgbToHex(newR, newG, newB);
            state[type] = newHex;
            updateUI(); 
        }
        
        function clamp(num) { return Math.min(Math.max(Math.round(num), 0), 255); }

        // --- Core UI Updates ---
        function updateColor(type, hex) {
            state[type] = hex;
            updateUI(type); 
        }

        function updateUI(skipInputType = null) {
            els.bgPicker.value = state.bg;
            els.textPicker.value = state.text;
            els.bgVisual.style.backgroundColor = state.bg;
            els.textVisual.style.backgroundColor = state.text;

            const getDisplayValue = (hex) => {
                if (state.displayFormat === 'hex') return hex.toUpperCase();
                const rgb = hexToRgb(hex);
                return `${rgb.r}, ${rgb.g}, ${rgb.b}`;
            };

            if (skipInputType !== 'bg') els.bgText.value = getDisplayValue(state.bg);
            if (skipInputType !== 'text') els.textText.value = getDisplayValue(state.text);

            els.card.style.backgroundColor = state.bg;
            els.card.style.color = state.text;

            els.slideContainer.style.backgroundColor = state.bg;
            els.slideContainer.style.color = state.text;
            els.slideBgVal.textContent = state.bg.toUpperCase();
            els.slideTextVal.textContent = state.text.toUpperCase();
            
            const ratio = calculateContrastRatio(state.bg, state.text);
            els.ratioDisplay.textContent = ratio.toFixed(2);
            els.ratioDisplay.style.color = getRateColor(ratio);

            updateBadges(ratio);
        }

        function updateSlideCompliance() {
            const ratio = calculateContrastRatio(state.bg, state.text);
            
            // High Visibility Icons (Green Check / Red X)
            const pass = '<i class="fa-solid fa-check text-green-500"></i>';
            const fail = '<i class="fa-solid fa-xmark text-red-500"></i>';
            
            const updateBadge = (el, passed, label) => {
                el.innerHTML = `${passed ? pass : fail} ${label}`;
                // Removed opacity shift for failure, keep it bright to show "X" clearly.
                el.style.opacity = '1'; 
            };
            
            updateBadge(els.slideBadges.aaNorm, ratio >= 4.5, 'AA');
            updateBadge(els.slideBadges.aaaNorm, ratio >= 7.0, 'AAA');
            updateBadge(els.slideBadges.aaLarge, ratio >= 3.0, 'AA');
            updateBadge(els.slideBadges.aaaLarge, ratio >= 4.5, 'AAA');
        }

        // --- Download ---
        function downloadSlide() {
            const btn = els.btnDownloadSlide;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing';
            html2canvas(els.slideContainer, { scale: 2, backgroundColor: null, useCORS: true }).then(canvas => {
                const link = document.createElement('a');
                link.download = `brandsafe-slide-${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
                btn.innerHTML = originalText;
            });
        }

        // --- Mode & Format ---
        function setMode(mode) {
            state.activeMode = mode;
            if (mode === 'bg') {
                els.controlBg.classList.add('mode-active');
                els.controlBg.classList.remove('mode-inactive');
                els.indicatorBg.classList.add('bg-blue-500');
                els.indicatorBg.classList.remove('bg-slate-600');
                els.controlText.classList.remove('mode-active');
                els.controlText.classList.add('mode-inactive');
                els.indicatorText.classList.remove('bg-blue-500');
                els.indicatorText.classList.add('bg-slate-600');
            } else {
                els.controlText.classList.add('mode-active');
                els.controlText.classList.remove('mode-inactive');
                els.indicatorText.classList.add('bg-blue-500');
                els.indicatorText.classList.remove('bg-slate-600');
                els.controlBg.classList.remove('mode-active');
                els.controlBg.classList.add('mode-inactive');
                els.indicatorBg.classList.remove('bg-blue-500');
                els.indicatorBg.classList.add('bg-slate-600');
            }
        }

        window.toggleFormat = function(fmt) {
            state.displayFormat = fmt;
            if (fmt === 'hex') {
                els.fmtHex.classList.add('bg-slate-600', 'text-white');
                els.fmtHex.classList.remove('text-slate-500');
                els.fmtRgb.classList.remove('bg-slate-600', 'text-white');
                els.fmtRgb.classList.add('text-slate-500');
            } else {
                els.fmtRgb.classList.add('bg-slate-600', 'text-white');
                els.fmtRgb.classList.remove('text-slate-500');
                els.fmtHex.classList.remove('bg-slate-600', 'text-white');
                els.fmtHex.classList.add('text-slate-500');
            }
            updateUI();
        }

        function handleManualInput(type, value) {
            const cleanVal = value.trim();
            if (state.displayFormat === 'hex') {
                if (isValidHex(cleanVal)) {
                    let hex = cleanVal;
                    if (!hex.startsWith('#')) hex = '#' + hex;
                    state[type] = hex;
                    if(type === 'bg') state.baseBg = hex;
                    if(type === 'text') state.baseText = hex;
                    updateUI(type); 
                }
            } else {
                const rgbParts = cleanVal.split(',').map(n => parseInt(n.trim()));
                if (rgbParts.length === 3 && rgbParts.every(n => !isNaN(n) && n >= 0 && n <= 255)) {
                    const hex = rgbToHex(rgbParts[0], rgbParts[1], rgbParts[2]);
                    state[type] = hex;
                    if(type === 'bg') state.baseBg = hex;
                    if(type === 'text') state.baseText = hex;
                    updateUI(type);
                }
            }
        }

        // --- Helpers ---
        function updateBadges(ratio) {
            const passIcon = '<i class="fa-solid fa-circle-check text-lg"></i>';
            const failIcon = '<i class="fa-solid fa-circle-xmark text-lg"></i>';
            const setBadge = (el, passed) => {
                el.innerHTML = passed ? passIcon : failIcon;
                el.className = passed ? 'text-green-500 shrink-0' : 'text-red-500 shrink-0';
            };
            setBadge(els.badges.aaNorm, ratio >= 4.5);
            setBadge(els.badges.aaaNorm, ratio >= 7.0);
            setBadge(els.badges.aaLarge, ratio >= 3.0);
            setBadge(els.badges.aaaLarge, ratio >= 4.5);
        }
        function getRateColor(ratio) {
            if (ratio >= 7) return '#4ade80'; 
            if (ratio >= 4.5) return '#facc15'; 
            if (ratio >= 3) return '#fb923c'; 
            return '#f87171'; 
        }
        function isValidHex(hex) { return /^#?[0-9A-F]{6}$/i.test(hex); }
        function rgbToHex(r, g, b) { return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1); }
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : { r: 0, g: 0, b: 0 };
        }
        function getLuminance(r, g, b) {
            const a = [r, g, b].map(function(v) { v /= 255; return v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4); });
            return a[0] * 0.2126 + a[1] * 0.7152 + a[2] * 0.0722;
        }
        function calculateContrastRatio(hex1, hex2) {
            const rgb1 = hexToRgb(hex1);
            const rgb2 = hexToRgb(hex2);
            if (!rgb1 || !rgb2) return 1;
            const lum1 = getLuminance(rgb1.r, rgb1.g, rgb1.b);
            const lum2 = getLuminance(rgb2.r, rgb2.g, rgb2.b);
            const bright = Math.max(lum1, lum2);
            const dark = Math.min(lum1, lum2);
            return (bright + 0.05) / (dark + 0.05);
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
